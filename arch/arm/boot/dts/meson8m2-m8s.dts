/*
 * Copyright (c) 2017 Martin Blumenstingl <martin.blumenstingl@googlemail.com>.
 *
 * SPDX-License-Identifier: (GPL-2.0+ OR MIT)
 */

/dts-v1/;

#include "meson8m2.dtsi"

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>

/ {
	model = "Akaso M8S";
	compatible = "akaso,m8s", "amlogic,meson8m2";

	aliases {
		ethernet0 = &ethmac;
		serial0 = &uart_AO;
		serial1 = &uart_A;
		mmc0 = &sdhc;
		mmc1 = &sdio_wireless_slot;
	};

	chosen {
		stdout-path = "serial0:115200n8";
	};

	memory {
		device_type = "memory";
		reg = <0x40000000 0x80000000>;
	};

	adc-keys {
		compatible = "adc-keys";
		io-channels = <&saradc 0>;
		io-channel-names = "buttons";
		keyup-threshold-microvolt = <1710000>;

		button-function {
			label = "Function";
			linux,code = <KEY_FN>;
			press-threshold-microvolt = <10000>;
		};
	};

	iio-hwmon {
		compatible = "iio-hwmon";
		io-channels = <&saradc 8>;
	};

	pwmleds {
		compatible = "pwm-leds";

		power {
			label = "m8s:blue:power";
			pwms = <&pwm_ef 1 7812500 0>;
			max-brightness = <255>;
			active-low;
			linux,default-trigger = "default-on";
		};
	};

	sdio_pwrseq: sdio-pwrseq {
		compatible = "mmc-pwrseq-simple";
		reset-gpios = <&gpio_ao GPIOAO_6 GPIO_ACTIVE_HIGH>,
			      <&gpio GPIOX_11 GPIO_ACTIVE_HIGH>;
		clocks = <&xtal_32k_out>;
		clock-names = "ext_clock";
		pinctrl-0 = <&xtal_32k_out_pins>;
		pinctrl-names = "default";
	};

	tv-connector {
		compatible = "composite-video-connector";

		port {
			cvbs_connector_in: endpoint {
				remote-endpoint = <&cvbs_vdac_out>;
			};
		};
	};

	vcck: regulator-vcck {
		compatible = "regulator-fixed";
		regulator-name = "VCCK";
		regulator-min-microvolt = <975000>;
		regulator-max-microvolt = <975000>;
	};

	vcc_1v8: regulator-vcc1v8 {
		compatible = "regulator-fixed";
		regulator-name = "VCC1V8";
		regulator-min-microvolt = <1800000>;
		regulator-max-microvolt = <1800000>;
	};

	vcc_3v3: regulator-vcc3v3 {
		compatible = "regulator-fixed";
		regulator-name = "VCC3V3";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
	};

	xtal_32k_out: xtal-32k-out-clk {
		compatible = "fixed-clock";
		#clock-cells = <0>;
		clock-frequency = <32768>;
		clock-output-names = "xtal_32k_out";
	};
};

&cpu0 {
	cpu-supply = <&vcck>;
};

&cvbs_vdac_port {
	cvbs_vdac_out: endpoint {
		remote-endpoint = <&cvbs_connector_in>;
	};
};

&ethmac {
	status = "okay";

	pinctrl-0 = <&eth_pins>;
	pinctrl-names = "default";

	phy-handle = <&eth_phy0>;
	phy-mode = "rmii";

	snps,reset-gpio = <&gpio GPIOZ_14 0>;
	snps,reset-delays-us = <0 10000 1000000>;
	snps,reset-active-low;

	mdio {
		compatible = "snps,dwmac-mdio";
		#address-cells = <1>;
		#size-cells = <0>;

		eth_phy0: ethernet-phy@0 {
			/* IC Plus IP101GR (0x02430c54) */
			reg = <0>;
		};
	};
};

&ir_receiver {
	status = "okay";
	pinctrl-0 = <&ir_recv_pins>;
	pinctrl-names = "default";
};

&nfc {
	/* TODO: status = "okay"; */

	pinctrl-0 = <&nand_pins>, <&nand_ce0_pins>, <&nand_rb0_pins>;
	pinctrl-names = "default";

	nand@0 {
		reg = <0>;

		nand-on-flash-bbt;

		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			partition@2 {
				label = "2GiB";
				reg = <0x0 0xffffffff>;
				read-only;
			};

			partition@0 {
				label = "nand_page0_cfg";
				reg = <0x0 0x4000>;
				read-only;
			};

			partition@4000 {
				label = "u-boot";
				reg = <0x4000 0x60000>;
				read-only;
			};

			partition@400000 {
				label = "u-boot-env";
				reg = <0x400000 0x10000>;
				read-only;
			};

			partition@1000000 {
				label = "boot";
				reg = <0x1000000 0x400000>;
				read-only;
			};

			partition@1400000 {
				label = "uboot_p1";
				reg = <0x1400000 0x8000000>;
				read-only;
			};

			partition@d000000 {
				label = "cache";
				reg = <0xd000000 0x19000000>;
				read-only;
			};

			partition@33000000 {
				label = "system";
				reg = <0x33000000 0x1f000000>;
				read-only;
			};

			partition@85000000 {
				label = "data";
				reg = <0x85000000 0xf6000000>;
				read-only;
			};
		};
	};
};

&pwm_ef {
	status = "disabled"; /* TODO: causes lockups */
	pinctrl-0 = <&pwm_f_ao_pins>;
	pinctrl-names = "default";
	clocks = <&clkc CLKID_FCLK_DIV3>, <&clkc CLKID_FCLK_DIV4>;
	clock-names = "clkin0", "clkin1";
};

&saradc {
	status = "okay";
	vref-supply = <&vcc_1v8>;
};

&sdhc {
	status = "okay";

	pinctrl-0 = <&sdxc_b_pins>;
	pinctrl-names = "default";

	bus-width = <4>;
	no-sdio;
	cap-mmc-highspeed;
	cap-sd-highspeed;
	disable-wp;

	cd-gpios = <&gpio CARD_6 GPIO_ACTIVE_LOW>;

	vmmc-supply = <&vcc_3v3>;
	vqmmc-supply = <&vcc_3v3>;
};

&sdio {
	status = "okay";

	pinctrl-0 = <&sd_a_pins>;
	pinctrl-names = "default";

	sdio_wireless_slot: slot@0 {
		compatible = "mmc-slot";
		reg = <0>;

		bus-width = <4>;
		cap-mmc-highspeed;
		cap-sd-highspeed;
		non-removable;
		disable-wp;

		mmc-pwrseq = <&sdio_pwrseq>;

		vmmc-supply = <&vcc_3v3>;
	};
};

&uart_A {
	status = "okay";
	pinctrl-0 = <&uart_a1_pins>, <&uart_a1_cts_rts_pins>;
	pinctrl-names = "default";
	uart-has-rtscts;

	bluetooth {
		compatible = "realtek,rtl8723bs-bluetooth";
		enable-gpios = <&gpio GPIOX_20 GPIO_ACTIVE_HIGH>;
		realtek,config-data = /bits/ 8 <
			0x55 0xab 0x23 0x87 0x31 0x00 0xf4 0x00 0x08 0x01 0x00 0x00
			0x00 0x05 0x50 0x00 0x00 0x0c 0x00 0x10 0x02 0x80 0x92 0x04
			0x50 0xc5 0xea 0x19 0xe1 0x1b 0xf1 0xaf 0x5f 0x01 0xa4 0x0b
			0x27 0x00 0x01 0x63 0xfe 0x00 0x01 0x01 0x5b 0x01 0x04 0x0b
			0x0b 0x0b 0x0a 0xe3 0x01 0x01 0x00
		>;
	};
};

&uart_AO {
	status = "okay";
	pinctrl-0 = <&uart_ao_a_pins>;
	pinctrl-names = "default";
};

&usb0 {
	status = "okay";
};

&usb1 {
	status = "okay";
};

&usb0_phy {
	status = "okay";
};

&usb1_phy {
	status = "okay";
};
